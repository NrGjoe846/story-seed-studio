import { useState, useEffect } from 'react';
import { useParams, useNavigate, Link, useSearchParams } from 'react-router-dom';
import { Smartphone, QrCode, ArrowRight, Loader2, Check, School, GraduationCap, Copy } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { useToast } from '@/hooks/use-toast';
import { supabase } from '@/integrations/supabase/client';

declare global {
  interface Window {
    Razorpay: any;
  }
}

const generateUniqueKey = () => {
  return Math.random().toString(36).substring(2, 10).toUpperCase();
};

const PaymentPortal = () => {
  const { eventId } = useParams();
  const [searchParams] = useSearchParams();
  const navigate = useNavigate();
  const { toast } = useToast();

  const [event, setEvent] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [submitting, setSubmitting] = useState(false);
  const [user, setUser] = useState<any>(null);

  const [step, setStep] = useState<1 | 2 | 3>(1); // 1: Personal, 2: Payment, 3: Success
  const [personalInfo, setPersonalInfo] = useState({
    firstName: '',
    lastName: '',
    phone: '',
    age: '',
    city: '',
    schoolName: '',
    collegeName: '',
    classLevel: '',
    degree: '',
    branch: '',
    role: null as 'school' | 'college' | null
  });

  const [paymentMethod, setPaymentMethod] = useState<'upi' | 'qr'>('upi');
  const [transactionId, setTransactionId] = useState('');
  const [senderName, setSenderName] = useState('');
  const [uniqueKey, setUniqueKey] = useState('');

  useEffect(() => {
    const checkAuthAndFetchEvent = async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        toast({
          title: 'Login Required',
          description: 'Please log in to participate in events.',
          variant: 'destructive',
        });
        navigate(`/user?redirect=/pay-event/${eventId}`);
        return;
      }
      setUser(session.user);

      if (!eventId) return;

      const { data, error } = await supabase
        .from('events')
        .select('*')
        .eq('id', eventId)
        .single();

      if (error || !data) {
        toast({
          title: 'Error',
          description: 'Event not found.',
          variant: 'destructive',
        });
        navigate('/');
        return;
      }
      setEvent(data);

      // Auto-set role if fixed
      if (data.event_type === 'school') {
        setPersonalInfo(prev => ({ ...prev, role: 'school' }));
      } else if (data.event_type === 'college') {
        setPersonalInfo(prev => ({ ...prev, role: 'college' }));
      }

      setLoading(false);
    };

    checkAuthAndFetchEvent();
  }, [eventId, navigate, toast]);

  const validatePersonalStep = () => {
    const { firstName, lastName, phone, age, city, role } = personalInfo;
    if (!firstName || !lastName || !phone || !age || !city || !role) {
      toast({
        title: 'Missing Information',
        description: 'Please fill all personal details and select your role.',
        variant: 'destructive',
      });
      return false;
    }

    if (role === 'school' && !personalInfo.schoolName) {
      toast({ title: 'School Name Required', variant: 'destructive' });
      return false;
    }
    if (role === 'college' && !personalInfo.collegeName) {
      toast({ title: 'College Name Required', variant: 'destructive' });
      return false;
    }

    return true;
  };

  const handleRazorpayPayment = async () => {
    try {
      setSubmitting(true); // Use submitting for payment process

      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        toast({ title: 'Error', description: 'You must be logged in to pay.', variant: 'destructive' });
        setSubmitting(false);
        return;
      }

      // 1. Validate registration fee
      if (!event.registration_fee || event.registration_fee <= 0) {
        toast({ title: 'Error', description: 'Event registration fee not set. Please contact support.', variant: 'destructive' });
        setSubmitting(false);
        return;
      }

      // 2. Create Order
      const { data: orderData, error: orderError } = await supabase.functions.invoke('razorpay-handler', {
        body: { action: 'create-order', amount: Math.round(event.registration_fee * 100) }, // Amount in paisa
      });

      if (orderError || !orderData?.id) {
        console.error('Order creation error:', orderError);
        throw new Error(orderError?.message || 'Failed to create order');
      }

      // 2. Open Razorpay Checkout
      const options = {
        key: import.meta.env.VITE_RAZORPAY_KEY_ID, // User needs to set this
        amount: orderData.amount,
        currency: orderData.currency,
        name: "Story Seed Studio",
        description: "Competition Registration Fee",
        image: "/assets/logo.png",
        order_id: orderData.id,
        handler: async function (response: any) {
          try {
            // 3. Verify Signature
            const { data: verifyData, error: verifyError } = await supabase.functions.invoke('razorpay-handler', {
              body: {
                action: 'verify-signature',
                razorpay_order_id: response.razorpay_order_id,
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_signature: response.razorpay_signature,
              },
            });

            if (verifyError || !verifyData?.success) {
              throw new Error('Payment verification failed');
            }

            // 4. Submit Registration (Signature verified)
            await submitPaymentToDB({
              paymentId: response.razorpay_payment_id,
              orderId: response.razorpay_order_id,
              signature: response.razorpay_signature,
              amount: event.registration_fee,
              method: 'razorpay'
            });

          } catch (err: any) {
            console.error('Verification Error:', err);
            toast({ title: 'Payment Verification Failed', description: err.message, variant: 'destructive' });
          }
        },
        prefill: {
          name: `${personalInfo.firstName} ${personalInfo.lastName}`,
          email: session.user.email,
          contact: personalInfo.phone,
        },
        theme: {
          color: "#9B1B1B",
        },
        modal: {
          ondismiss: function () {
            setSubmitting(false); // Reset submitting if modal is dismissed
          }
        }
      };

      const rzp = new window.Razorpay(options);
      rzp.on('payment.failed', function (response: any) {
        toast({ title: 'Payment Failed', description: response.error.description, variant: 'destructive' });
        setSubmitting(false); // Reset submitting on payment failure
      });
      rzp.open();

    } catch (error: any) {
      console.error('Payment Error:', error);
      toast({ title: 'Payment Error', description: error.message, variant: 'destructive' });
      setSubmitting(false); // Reset submitting on any error
    }
  };

  const submitPaymentToDB = async (paymentDetails: any) => {
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;
      const user = session.user;
      const key = generateUniqueKey();

      const tableName = personalInfo.role === 'school' ? 'registrations' : 'clg_registrations';

      const payload: any = {
        event_id: eventId,
        user_id: user.id,
        first_name: personalInfo.firstName,
        last_name: personalInfo.lastName,
        email: user.email,
        phone: personalInfo.phone,
        age: parseInt(personalInfo.age),
        city: personalInfo.city,
        story_title: '',
        category: '',
        story_description: '',
        payment_status: 'paid', // Update status
        unique_key: key,
        payment_details: paymentDetails, // Store full Razorpay details
      };

      if (personalInfo.role === 'school') {
        payload.school_name = personalInfo.schoolName;
        payload.class_level = personalInfo.classLevel;
      } else {
        payload.college_name = personalInfo.collegeName;
        payload.degree = personalInfo.degree;
        payload.branch = personalInfo.branch;
      }

      const { error } = await supabase
        .from(tableName)
        .insert(payload);

      if (error) throw error;

      // Update profile institution/college
      if (user.id) {
        const profileUpdate: any = {};
        if (personalInfo.role === 'school' && personalInfo.schoolName) {
          profileUpdate.institution = personalInfo.schoolName;
        } else if (personalInfo.role === 'college' && personalInfo.collegeName) {
          profileUpdate.institution = personalInfo.collegeName;
        }

        if (Object.keys(profileUpdate).length > 0) {
          await supabase.from('profiles').update(profileUpdate).eq('id', user.id);
        }
      }

      setUniqueKey(key);
      setStep(3);
      toast({ title: 'Success', description: 'Payment successful! Registration complete.', });
    } catch (error: any) {
      console.error('DB Insert Error:', error);
      toast({ title: 'Registration Failed', description: error.message + ' (Payment was successful, please contact support)', variant: 'destructive' });
    } finally {
      setSubmitting(false);
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <Loader2 className="w-8 h-8 animate-spin text-primary" />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-background py-20">
      <div className="container mx-auto px-4 max-w-2xl">
        <div className="text-center mb-10">
          <h1 className="text-4xl font-display font-bold mb-4">Event <span className="text-gradient">Participation</span></h1>
          <p className="text-muted-foreground text-lg">
            {step === 1 ? 'Step 1: Personal Details' : step === 2 ? 'Step 2: Payment' : 'Step 3: Registration Key'}
          </p>
          <p className="text-primary font-medium">{event.name}</p>
        </div>

        <div className="backdrop-blur-xl bg-white/10 dark:bg-black/10 border border-white/20 dark:border-white/10 rounded-3xl p-8 shadow-2xl">
          {step === 1 && (
            <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4">
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>First Name</Label>
                  <Input
                    value={personalInfo.firstName}
                    onChange={e => setPersonalInfo(p => ({ ...p, firstName: e.target.value }))}
                    placeholder="John"
                  />
                </div>
                <div className="space-y-2">
                  <Label>Last Name</Label>
                  <Input
                    value={personalInfo.lastName}
                    onChange={e => setPersonalInfo(p => ({ ...p, lastName: e.target.value }))}
                    placeholder="Doe"
                  />
                </div>
              </div>

              <div className="space-y-2">
                <Label>Phone Number</Label>
                <Input
                  value={personalInfo.phone}
                  onChange={e => setPersonalInfo(p => ({ ...p, phone: e.target.value }))}
                  placeholder="+91..."
                />
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>Age</Label>
                  <Input
                    type="number"
                    value={personalInfo.age}
                    onChange={e => setPersonalInfo(p => ({ ...p, age: e.target.value }))}
                    placeholder="18"
                  />
                </div>
                <div className="space-y-2">
                  <Label>City</Label>
                  <Input
                    value={personalInfo.city}
                    onChange={e => setPersonalInfo(p => ({ ...p, city: e.target.value }))}
                    placeholder="Bangalore"
                  />
                </div>
              </div>

              {event.event_type === 'both' && (
                <div className="space-y-2">
                  <Label>Select Category</Label>
                  <div className="grid grid-cols-2 gap-4">
                    <Button
                      onClick={() => setPersonalInfo(p => ({ ...p, role: 'school' }))}
                      variant={personalInfo.role === 'school' ? 'default' : 'outline'}
                      className="h-12"
                    >
                      <School className="mr-2 h-4 w-4" /> School
                    </Button>
                    <Button
                      onClick={() => setPersonalInfo(p => ({ ...p, role: 'college' }))}
                      variant={personalInfo.role === 'college' ? 'default' : 'outline'}
                      className="h-12"
                    >
                      <GraduationCap className="mr-2 h-4 w-4" /> College
                    </Button>
                  </div>
                </div>
              )}

              {personalInfo.role === 'school' && (
                <div className="space-y-2">
                  <Label>School Name</Label>
                  <Input
                    value={personalInfo.schoolName}
                    onChange={e => setPersonalInfo(p => ({ ...p, schoolName: e.target.value }))}
                    placeholder="Enter school name"
                  />
                </div>
              )}

              {personalInfo.role === 'college' && (
                <div className="space-y-2">
                  <Label>College Name</Label>
                  <Input
                    value={personalInfo.collegeName}
                    onChange={e => setPersonalInfo(p => ({ ...p, collegeName: e.target.value }))}
                    placeholder="Enter college name"
                  />
                </div>
              )}

              <Button
                onClick={() => { if (validatePersonalStep()) setStep(2); }}
                className="w-full h-14 bg-primary text-white text-lg font-bold rounded-2xl"
              >
                Continue to Payment
                <ArrowRight className="w-6 h-6 ml-2" />
              </Button>
            </div>
          )}

          {step === 2 && (
            <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4">
              <div className="text-center">
                <h2 className="text-2xl font-bold mb-2">Registration Fee: ₹{event.registration_fee || 99}</h2>
                <p className="text-muted-foreground">Secure payment via Razorpay</p>
              </div>

              <div className="bg-muted p-4 rounded-lg flex items-center justify-between">
                <div>
                  <p className="font-medium">{event?.name}</p>
                  <p className="text-sm text-muted-foreground">{personalInfo.role === 'school' ? 'School' : 'College'} Category</p>
                </div>
                <div className="font-bold text-xl">₹{event.registration_fee || 99}.00</div>
              </div>

              <div className="flex gap-4">
                <Button onClick={() => setStep(1)} variant="ghost" disabled={submitting} className="h-12">Back</Button>
                <Button onClick={handleRazorpayPayment} disabled={submitting} className="flex-1 h-12 bg-[#9B1B1B] hover:bg-[#7d1616] text-white">
                  {submitting ? <Loader2 className="animate-spin mr-2" /> : 'Pay Now'}
                </Button>
              </div>
            </div>
          )}

          {step === 3 && (
            <div className="space-y-8 animate-in zoom-in-95 text-center">
              <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <Check className="w-10 h-10 text-green-600" />
              </div>
              <div>
                <h2 className="text-3xl font-bold mb-2">Payment Successful!</h2>
                <p className="text-muted-foreground">Your transaction has been recorded and is pending verification.</p>
              </div>

              <div className="bg-primary/5 border border-primary/20 rounded-3xl p-8 space-y-4">
                <p className="text-sm font-medium text-muted-foreground uppercase tracking-widest">Your Unique Registration Key</p>
                <div className="flex flex-col items-center gap-4">
                  <div className="text-5xl font-mono font-bold text-primary tracking-widest select-all">
                    {uniqueKey}
                  </div>
                  <Button
                    variant="ghost"
                    size="sm"
                    className="text-primary hover:text-primary/80 hover:bg-primary/5"
                    onClick={() => {
                      navigator.clipboard.writeText(uniqueKey);
                      toast({ title: 'Key Copied!', description: 'Unique key copied to clipboard.' });
                    }}
                  >
                    <Copy className="w-4 h-4 mr-2" />
                    Copy Key
                  </Button>
                </div>
                <p className="text-xs text-muted-foreground">Please save this key safely. You will need it to submit your story once registration opens.</p>
              </div>

              <div className="space-y-4">
                <Button
                  onClick={() => navigate('/dashboard')}
                  className="w-full h-14 bg-primary text-white text-lg font-bold rounded-2xl"
                >
                  Go to Dashboard
                </Button>
                <Link to="/" className="block text-sm text-muted-foreground hover:text-foreground">
                  Back to Home
                </Link>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default PaymentPortal;
